/*
    Copyright 2013 Christopher Konze, University of Kassel
 
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/

using CrypTool.Plugins.VisualEncoder.Model;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.IO;


namespace CrypTool.Plugins.VisualEncoder.Encoders
{
    internal class DimCodeEncoder
    {
        protected readonly VisualEncoder caller;

        protected DimCodeEncoder(VisualEncoder caller)
        {
            this.caller = caller;
        }

        /// <summary>
        /// extern reachable encode methode
        /// </summary>
        /// <returns> combind a DimCodeReturnValue by using childclass's methods</returns>
        public DimCodeEncoderItem Encode(string input, VisualEncoderSettings settings)
        {
            input = EnrichInput(input, settings);

            if (VerifyInput(input, settings))
            {
                Image pureBitmap = GenerateBitmap(input, settings);
                Image preBitmap = GeneratePresentationBitmap(pureBitmap, settings);
                return new DimCodeEncoderItem
                {
                    Legend = GetLegend(input, settings),
                    PureBitmap = ImageToByteArray(pureBitmap),
                    PresentationBitmap = ImageToByteArray(preBitmap)
                };
            }
            return null;
        }

        /// <summary>
        /// enrich the prue Bitmap with colors to explain certain areas of the DimCode
        /// </summary>
        /// <param name="pureBitmap"></param>
        /// <param name="settings"></param>
        /// <returns></returns>
        protected virtual Image GeneratePresentationBitmap(Image pureBitmap, VisualEncoderSettings settings)
        {
            throw new NotImplementedException();
        }

        /// <summary>
        /// the legend has to explain the corresponding colors in the presentation Bitmap, generated by child classes
        /// </summary>
        /// <param name="input"></param>
        /// <param name="settings"></param>
        /// <returns></returns>
        protected virtual List<LegendItem> GetLegend(string input, VisualEncoderSettings settings)
        {
            throw new NotImplementedException();
        }


        /// <summary>
        /// the origin encode methode each child should override with the dim-code's specific encode methode.
        /// </summary>
        /// <param name="input"></param>
        /// <param name="settings"></param>
        /// <returns>returns the image of the dim-Code</returns>
        protected virtual Image GenerateBitmap(string input, VisualEncoderSettings settings)
        {
            throw new NotImplementedException();
        }

        /// <summary>
        ///  each child should override this to tell the enduser what is wrong by using the caller.GuiLogMessage
        /// </summary>
        /// <param name="input"></param>
        /// <param name="settings"></param>
        /// <returns>has to return true if no error occurred</returns>
        protected virtual bool VerifyInput(string input, VisualEncoderSettings settings)
        {
            return true;
        }


        // this may be some kind of integrity check value, or, if your code has a fixed size ,some pad
        /// <summary>
        /// gives the child class the ability to enrich the input before validating.
        /// </summary>
        /// <param name="input"></param>
        /// <param name="settings"></param>
        /// <returns>enriched Input</returns>
        protected virtual string EnrichInput(string input, VisualEncoderSettings settings)
        {
            return input;
        }
        #region helper



        public byte[] ImageToByteArray(Image imageIn)
        {
            using (MemoryStream ms = new MemoryStream())
            {
                imageIn.Save(ms, System.Drawing.Imaging.ImageFormat.Bmp);
                byte[] image = ms.ToArray();
                ms.Dispose();
                return image;
            }
        }

        /// <summary>
        /// calculates and returns the hight of a black area inside of the given bitmap at x
        /// </summary>
        protected static int CalcBarHight(Bitmap bitmap, int x)
        {
            int barHight = 0;
            bool onBar = false;

            LockBitmap lockBitmap = new LockBitmap(bitmap);
            lockBitmap.LockBits();
            for (int y = 0; y < bitmap.Height; y++)
            {
                byte p = lockBitmap.GetPixel(x, y).R;
                if (onBar && p != Color.Black.R)
                {
                    barHight = y - 1;
                    y = lockBitmap.Height;
                }
                else
                {
                    onBar = lockBitmap.GetPixel(x, y).R == Color.Black.R;
                }
            }
            lockBitmap.UnlockBits();
            return barHight;
        }

        /// <summary>
        /// Colors the given bitmap at x, between yfrom and yto.
        /// If the old color of a point x,y was black, the new color will be cBlack, elsewise it will be cWhite. 
        /// </summary>
        protected static Bitmap FillBitmapOnX(int x, int yFrom, int yTo, Bitmap bitmap, Color cBlack, Color cWhite)
        {
            LockBitmap lockBitmap = new LockBitmap(bitmap);
            lockBitmap.LockBits();


            for (; yFrom <= yTo; yFrom++)
            {
                lockBitmap.SetPixel(x, yFrom, lockBitmap.GetPixel(x, yFrom).R == Color.Black.R ? cBlack : cWhite);
            }
            lockBitmap.UnlockBits();
            return bitmap;
        }

        /// <summary>
        /// Colors the given bitmap.
        /// If the old color of a point x,y was black, the new color will be cBlack, elsewise it will be cWhite. 
        /// </summary>
        protected static Bitmap FillArea(int xFrom, int xTo, int yFrom, int yTo, Bitmap bitmap, Color cBlack, Color cWhite)
        {
            for (; xFrom <= xTo; xFrom++)
            {
                FillBitmapOnX(xFrom, yFrom, yTo, bitmap, cBlack, cWhite);
            }

            return bitmap;
        }

        #endregion helper


    }
}
